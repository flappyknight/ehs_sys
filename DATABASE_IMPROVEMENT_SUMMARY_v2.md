# æ•°æ®åº“æ”¹è¿›æ–¹æ¡ˆæ€»ç»“ï¼ˆv2.0 - ä¸»ä½“åˆ†ç¦»ç‰ˆï¼‰

## ğŸ“‹ æ ¸å¿ƒæ”¹è¿›

æ ¹æ®æ‚¨æä¾›çš„ä¸šåŠ¡éœ€æ±‚ï¼Œæœ¬æ¬¡æ”¹è¿›æ–¹æ¡ˆçš„æ ¸å¿ƒå˜æ›´å¦‚ä¸‹ï¼š

### 1. å››ä¸ªç‹¬ç«‹ä¸»ä½“

```
ç³»ç»Ÿä¸»ä½“æ¶æ„
â”œâ”€â”€ 1. ç³»ç»Ÿç®¡ç†å‘˜ï¼ˆadmin_accountï¼‰
â”œâ”€â”€ 2. ç”²æ–¹ä¼ä¸šï¼ˆenterpriseï¼‰
â”œâ”€â”€ 3. ä¼ä¸šäººå‘˜ï¼ˆenterprise_staff + enterprise_staff_accountï¼‰
â”œâ”€â”€ 4. æ‰¿åŒ…å•†ä¼ä¸šï¼ˆcontractorï¼‰
â””â”€â”€ 5. æ‰¿åŒ…å•†äººå‘˜ï¼ˆcontractor_staff + contractor_staff_accountï¼‰
```

**å…³é”®è¯´æ˜**ï¼š
- âŒ **ä¸å†ç»Ÿä¸€**ï¼šç”²æ–¹ä¼ä¸šå’Œæ‰¿åŒ…å•†ä¼ä¸šæ˜¯å®Œå…¨ç‹¬ç«‹çš„ä¸¤ä¸ªå®ä½“
- âœ… **è´¦å·åˆ†ç¦»**ï¼šä¸‰å¥—ç‹¬ç«‹è´¦å·è¡¨ï¼Œå„å¸å…¶èŒ
- âœ… **äººå‘˜ç‹¬ç«‹**ï¼šä¼ä¸šäººå‘˜å’Œæ‰¿åŒ…å•†äººå‘˜å„æœ‰ç‹¬ç«‹çš„ä¿¡æ¯è¡¨

---

### 2. å·¥å•æµç¨‹å¢å¼º

#### 2.1 å·¥å•çŠ¶æ€ç®€åŒ–
```
åªä¿ç•™ä¸¤ç§çŠ¶æ€ï¼š
- in_progressï¼šè¿›è¡Œä¸­
- completedï¼šå·²å®Œæˆ
```

#### 2.2 ç»ˆæ­¢ä¸åˆ é™¤åˆ†ç¦»
```
- ç»ˆæ­¢ï¼ˆis_terminatedï¼‰ï¼šå·¥å•ä¸­é€”åœæ­¢ï¼Œä¿ç•™æ‰€æœ‰è®°å½•
- åˆ é™¤ï¼ˆis_deletedï¼‰ï¼šè½¯åˆ é™¤ï¼Œä»…åˆ›å»ºè€…å’Œå®¡æ ¸äººå‘˜å¯æ“ä½œ
```

#### 2.3 å›é€€æœºåˆ¶
```
æ”¯æŒä¸‰ç§å›é€€ï¼š
1. å›é€€åˆ°ä¸Šä¸€æ­¥ï¼ˆrollbackï¼‰
2. å›é€€åˆ°å¼€å§‹ï¼ˆrollback_to_startï¼‰
3. ç»ˆæ­¢å·¥å•ï¼ˆterminateï¼‰
```

**æƒé™æ§åˆ¶**ï¼š
- **å·¥å•åˆ›å»ºè€…**ï¼šå¯å›é€€ä»»æ„æ­¥éª¤ã€è¿”å›å¼€å§‹ã€ç»ˆæ­¢ã€åˆ é™¤
- **å®¡æ ¸äººå‘˜**ï¼ˆ`can_approve_ticket=TRUE`ï¼‰ï¼šå¯å›é€€ä»»æ„æ­¥éª¤ã€è¿”å›å¼€å§‹ã€ç»ˆæ­¢ã€åˆ é™¤
- **æ“ä½œäººå‘˜**ï¼šå¯å›é€€åˆ°ä¸Šä¸€æ­¥ã€è¿”å›å¼€å§‹

#### 2.4 æµè½¬æ¡ä»¶éªŒè¯

æ¯æ¬¡å·¥å•æµè½¬å‰ï¼Œç³»ç»Ÿè‡ªåŠ¨éªŒè¯ï¼š
1. âœ… ä¸Šä¸€æ­¥æ˜¯å¦å·²å®Œæˆ
2. âœ… ä¸Šä¸€æ­¥å®¡æ‰¹æ˜¯å¦é€šè¿‡
3. âœ… å¿…å¡«å­—æ®µæ˜¯å¦å¡«å†™å®Œæ•´
4. âœ… æ“ä½œäººæ˜¯å¦æœ‰æƒé™
5. âœ… è‡ªå®šä¹‰æ¡ä»¶æ˜¯å¦æ»¡è¶³

**éªŒè¯å¤±è´¥æ—¶**ï¼š
- ç»™å‡ºæ˜ç¡®çš„å¤±è´¥åŸå› 
- è®°å½•åœ¨ `ticket_flow_logs.validation_errors` å­—æ®µ
- ä¸å…è®¸æµè½¬

---

### 3. æ–°å¢æ ¸å¿ƒè¡¨

| è¡¨å | ç”¨é€” | é‡è¦æ€§ |
|------|------|--------|
| `enterprise` | ç”²æ–¹ä¼ä¸šä¿¡æ¯ | â­â­â­â­â­ |
| `admin_account` | ç³»ç»Ÿç®¡ç†å‘˜è´¦å· | â­â­â­â­â­ |
| `enterprise_staff_account` | ä¼ä¸šäººå‘˜è´¦å· | â­â­â­â­â­ |
| `contractor_staff_account` | æ‰¿åŒ…å•†äººå‘˜è´¦å· | â­â­â­â­â­ |
| `account_change_logs` | è´¦å·å˜æ›´æ—¥å¿— | â­â­â­â­â­ |
| `enterprise_staff` | ä¼ä¸šäººå‘˜ä¿¡æ¯ | â­â­â­â­â­ |
| `contractor_staff` | æ‰¿åŒ…å•†äººå‘˜ä¿¡æ¯ | â­â­â­â­â­ |
| `workflow_definitions` | å·¥å•æµç¨‹å®šä¹‰ | â­â­â­â­â­ |
| `workflow_steps` | å·¥å•æµç¨‹æ­¥éª¤ | â­â­â­â­â­ |
| `ticket_approval_records` | å·¥å•å®¡æ‰¹è®°å½• | â­â­â­â­â­ |
| `ticket_flow_logs` | å·¥å•æµè½¬æ—¥å¿— | â­â­â­â­â­ |
| `ticket_step_instances` | å·¥å•æ­¥éª¤å®ä¾‹ | â­â­â­â­ |

---

### 4. é‡æ„çš„è¡¨

| è¡¨å | ä¸»è¦æ”¹è¿› |
|------|----------|
| `contractor` | ç‹¬ç«‹ç®¡ç†ï¼Œæ·»åŠ å®Œæ•´èµ„è´¨ä¿¡æ¯ |
| `ticket` | æ·»åŠ æµç¨‹æ”¯æŒã€ç»ˆæ­¢æœºåˆ¶ã€æµè½¬éªŒè¯ |
| `department` | å…³è”ç”²æ–¹ä¼ä¸šï¼Œæ·»åŠ è½¯åˆ é™¤ |
| `area` | å…³è”ç”²æ–¹ä¼ä¸šï¼Œæ·»åŠ è½¯åˆ é™¤ |
| `roles` | æ”¯æŒä¼ä¸šçº§å®šåˆ¶ |
| `role_permissions` | ç»†ç²’åº¦æƒé™é…ç½® |

---

## ğŸ¯ ä¸šåŠ¡é€»è¾‘å®ç°

### å·¥å•æµè½¬éªŒè¯ç¤ºä¾‹

```python
# æµè½¬å‰éªŒè¯
validation_passed, errors = validate_ticket_flow(
    ticket, current_step, next_step, operator
)

if not validation_passed:
    # è¿”å›éªŒè¯å¤±è´¥åŸå› 
    return {
        "success": False,
        "errors": [
            {"field": "approval", "message": "å½“å‰æ­¥éª¤éœ€è¦å®¡æ‰¹é€šè¿‡æ‰èƒ½æµè½¬"},
            {"field": "previous_step", "message": "ä¸Šä¸€æ­¥éª¤å°šæœªå®Œæˆ"}
        ]
    }
```

### å·¥å•å›é€€æƒé™æ£€æŸ¥

```python
def check_rollback_permission(ticket, operator):
    # åˆ›å»ºè€…ï¼šå¯å›é€€ä»»æ„æ­¥éª¤
    if operator.staff_id == ticket.creator_staff_id:
        return True
    
    # å®¡æ ¸äººå‘˜ï¼šå¯å›é€€ä»»æ„æ­¥éª¤
    if operator.can_approve_ticket:
        return True
    
    # å½“å‰æ“ä½œäººå‘˜ï¼šå¯å›é€€åˆ°ä¸Šä¸€æ­¥æˆ–å¼€å§‹
    current_instance = get_current_step_instance(ticket.ticket_id)
    if current_instance.assignee_staff_id == operator.staff_id:
        return True
    
    return False
```

### å·¥å•ç»ˆæ­¢

```python
def terminate_ticket(ticket, operator, reason):
    # æƒé™æ£€æŸ¥
    if not (operator.staff_id == ticket.creator_staff_id or 
            operator.can_terminate_ticket):
        raise PermissionError("åªæœ‰åˆ›å»ºè€…å’Œå®¡æ ¸äººå‘˜å¯ä»¥ç»ˆæ­¢å·¥å•")
    
    # ç»ˆæ­¢å·¥å•
    ticket.is_terminated = True
    ticket.terminated_at = datetime.now()
    ticket.terminated_by_staff_id = operator.staff_id
    ticket.termination_reason = reason
```

---

## ğŸ“Š è¡¨ç»“æ„å¯¹æ¯”

### æ”¹è¿›å‰
```
companyï¼ˆç»Ÿä¸€ç®¡ç†ç”²æ–¹å’Œæ‰¿åŒ…å•†ï¼‰
  â”œâ”€â”€ type='enterprise' æˆ– 'contractor'
  â””â”€â”€ æ··åˆå­—æ®µ

usersï¼ˆç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç”¨æˆ·ï¼‰
  â”œâ”€â”€ user_type='admin'/'enterprise'/'contractor'
  â”œâ”€â”€ enterprise_user_id
  â””â”€â”€ contractor_user_id
```

### æ”¹è¿›å
```
enterpriseï¼ˆç”²æ–¹ä¼ä¸šï¼‰
  â””â”€â”€ ç‹¬ç«‹è¡¨ï¼Œä¸“ç”¨å­—æ®µ

contractorï¼ˆæ‰¿åŒ…å•†ä¼ä¸šï¼‰
  â””â”€â”€ ç‹¬ç«‹è¡¨ï¼Œä¸“ç”¨å­—æ®µ

admin_accountï¼ˆç®¡ç†å‘˜è´¦å·ï¼‰
  â””â”€â”€ ç‹¬ç«‹è¡¨

enterprise_staff_accountï¼ˆä¼ä¸šäººå‘˜è´¦å·ï¼‰
  â””â”€â”€ ç‹¬ç«‹è¡¨

contractor_staff_accountï¼ˆæ‰¿åŒ…å•†äººå‘˜è´¦å·ï¼‰
  â””â”€â”€ ç‹¬ç«‹è¡¨

enterprise_staffï¼ˆä¼ä¸šäººå‘˜ä¿¡æ¯ï¼‰
  â””â”€â”€ ç‹¬ç«‹è¡¨

contractor_staffï¼ˆæ‰¿åŒ…å•†äººå‘˜ä¿¡æ¯ï¼‰
  â””â”€â”€ ç‹¬ç«‹è¡¨
```

---

## âœ… æ”¹è¿›æ•ˆæœ

### ä¸»ä½“åˆ†ç¦»
- âœ… ç”²æ–¹ä¼ä¸šå’Œæ‰¿åŒ…å•†ä¼ä¸šå®Œå…¨ç‹¬ç«‹
- âœ… è´¦å·ä½“ç³»æ¸…æ™°ï¼Œå„å¸å…¶èŒ
- âœ… äººå‘˜ä¿¡æ¯ç‹¬ç«‹ç®¡ç†

### å·¥å•æµç¨‹
- âœ… æ”¯æŒå¤æ‚æµç¨‹ï¼ˆé•¿æµç¨‹ã€åˆ†æ”¯ã€å®¡æ ¸ï¼‰
- âœ… æ”¯æŒå¤šçº§å›é€€ï¼ˆä¸Šä¸€æ­¥ã€å¼€å§‹ã€ç»ˆæ­¢ï¼‰
- âœ… æµè½¬å‰è‡ªåŠ¨éªŒè¯æ¡ä»¶
- âœ… éªŒè¯å¤±è´¥ç»™å‡ºæ˜ç¡®åŸå› 

### æƒé™æ§åˆ¶
- âœ… å·¥å•åˆ›å»ºè€…ï¼šæœ€é«˜æƒé™
- âœ… å®¡æ ¸äººå‘˜ï¼šç®¡ç†æƒé™
- âœ… æ“ä½œäººå‘˜ï¼šåŸºæœ¬æƒé™

### æ•°æ®å®‰å…¨
- âœ… è½¯åˆ é™¤æœºåˆ¶
- âœ… å®Œæ•´çš„æ“ä½œå®¡è®¡
- âœ… è¯¦ç»†çš„æµè½¬æ—¥å¿—

---

## ğŸ“ å®æ–½è¦ç‚¹

### 1. æ•°æ®è¿ç§»
```sql
-- ä»æ—§companyè¡¨è¿ç§»åˆ°æ–°è¡¨
-- ç”²æ–¹ä¼ä¸š
INSERT INTO enterprise (...)
SELECT ... FROM company WHERE type = 'enterprise';

-- æ‰¿åŒ…å•†ä¼ä¸š
INSERT INTO contractor (...)
SELECT ... FROM contractor_old;

-- è´¦å·è¿ç§»
INSERT INTO enterprise_staff_account (...)
SELECT ... FROM users WHERE user_type = 'enterprise';
```

### 2. ä»£ç è°ƒæ•´
- æ›´æ–°ç™»å½•é€»è¾‘ï¼ˆä¸‰å¥—è´¦å·è¡¨ï¼‰
- æ›´æ–°å·¥å•æµè½¬é€»è¾‘ï¼ˆå¢åŠ éªŒè¯ï¼‰
- æ›´æ–°æƒé™æ£€æŸ¥é€»è¾‘
- æ›´æ–°APIæ¥å£

### 3. æµ‹è¯•éªŒè¯
- è´¦å·ç™»å½•æµ‹è¯•
- å·¥å•æµè½¬æµ‹è¯•
- æƒé™æ§åˆ¶æµ‹è¯•
- æµè½¬éªŒè¯æµ‹è¯•

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡æ”¹è¿›æ–¹æ¡ˆå®Œå…¨æŒ‰ç…§æ‚¨çš„ä¸šåŠ¡éœ€æ±‚è®¾è®¡ï¼š

1. âœ… **å››ä¸ªç‹¬ç«‹ä¸»ä½“**ï¼šç”²æ–¹ä¼ä¸šã€æ‰¿åŒ…å•†ä¼ä¸šã€ä¼ä¸šäººå‘˜ã€æ‰¿åŒ…å•†äººå‘˜
2. âœ… **è´¦å·ä½“ç³»åˆ†ç¦»**ï¼šä¸‰å¥—ç‹¬ç«‹è´¦å·è¡¨
3. âœ… **å·¥å•æµç¨‹å¢å¼º**ï¼šæ”¯æŒå¤æ‚æµç¨‹ã€åˆ†æ”¯ã€å®¡æ ¸ã€å¤šçº§å›é€€
4. âœ… **æµè½¬æ¡ä»¶éªŒè¯**ï¼šæ¯æ­¥æµè½¬å‰éªŒè¯ï¼Œå¤±è´¥ç»™å‡ºåŸå› 
5. âœ… **çµæ´»å›é€€æœºåˆ¶**ï¼šæ”¯æŒå›é€€åˆ°ä¸Šä¸€æ­¥ã€å¼€å§‹ã€ç»ˆæ­¢
6. âœ… **æƒé™æ§åˆ¶ç²¾ç»†**ï¼šåˆ›å»ºè€…ã€å®¡æ ¸äººå‘˜ã€æ“ä½œäººå‘˜æƒé™æ˜ç¡®
7. âœ… **å·¥å•çŠ¶æ€ç®€åŒ–**ï¼šåªä¿ç•™è¿›è¡Œä¸­å’Œå·²å®Œæˆ
8. âœ… **ç»ˆæ­¢ä¸åˆ é™¤åˆ†ç¦»**ï¼šç»ˆæ­¢ä¿ç•™è®°å½•ï¼Œåˆ é™¤è½¯åˆ é™¤

**æ ¸å¿ƒæ”¹è¿›**ï¼š
- ä¸»ä½“å®Œå…¨ç‹¬ç«‹ï¼Œä¸å†æ··åˆç®¡ç†
- å·¥å•æµç¨‹å®Œå…¨å¯é…ç½®
- æµè½¬éªŒè¯è‡ªåŠ¨åŒ–
- æƒé™æ§åˆ¶ç²¾ç»†åŒ–

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-04  
**ä½œè€…**ï¼šAI Assistant  
**è¯¦ç»†æ–‡æ¡£**ï¼šDATABASE_IMPROVEMENT_PLAN.md

