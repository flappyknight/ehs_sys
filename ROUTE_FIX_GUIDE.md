# è·¯ç”±è·³è½¬é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·åœ¨å…¥é©»é€‰æ‹©é¡µé¢ç‚¹å‡»"ä¼ä¸šå…¥é©»"æˆ–"æ‰¿åŒ…å•†å…¥é©»"åï¼Œæ²¡æœ‰è·³è½¬åˆ°å¯¹åº”çš„ç”³è¯·é¡µé¢ï¼Œè€Œæ˜¯è¢«é‡å®šå‘å›ç™»å½•é¡µé¢ã€‚

## ğŸ” é—®é¢˜åŸå› 

è·¯ç”±é…ç½®ä¸­ï¼Œå…¥é©»ç”³è¯·ç›¸å…³çš„é¡µé¢è®¾ç½®äº† `meta: { requiresGuest: true }`ï¼Œè¿™ä¸ªé…ç½®çš„å«ä¹‰æ˜¯"åªå…è®¸æœªç™»å½•çš„è®¿å®¢è®¿é—®"ã€‚

è·¯ç”±å®ˆå«çš„é€»è¾‘ï¼š
```typescript
router.beforeEach(async (to, from, next) => {
  const authStore = useAuthStore()

  if (!authStore.isAuthenticated) {
    await authStore.checkAuth()
  }

  if (to.meta.requiresAuth && !authStore.isAuthenticated) {
    next('/login')  // éœ€è¦ç™»å½•ä½†æœªç™»å½• â†’ è·³è½¬ç™»å½•é¡µ
  } else if (to.meta.requiresGuest && authStore.isAuthenticated) {
    next('/dashboard')  // åªå…è®¸è®¿å®¢ä½†å·²ç™»å½• â†’ è·³è½¬ä»ªè¡¨æ¿
  } else {
    next()
  }
})
```

**é—®é¢˜åœºæ™¯ï¼š**
1. å¦‚æœç”¨æˆ·**æœªç™»å½•**ï¼Œè®¿é—®å…¥é©»é¡µé¢ â†’ æ­£å¸¸æ˜¾ç¤º âœ…
2. å¦‚æœç”¨æˆ·**å·²ç™»å½•**ï¼Œè®¿é—®å…¥é©»é¡µé¢ â†’ è¢«é‡å®šå‘åˆ° `/dashboard` âŒ

ä½†å®é™…ä¸Šï¼Œå…¥é©»ç”³è¯·åº”è¯¥å…è®¸**ä»»ä½•äºº**è®¿é—®ï¼ˆæ— è®ºæ˜¯å¦ç™»å½•ï¼‰ï¼Œå› ä¸ºï¼š
- æœªç™»å½•çš„ç”¨æˆ·å¯ä»¥ç”³è¯·å…¥é©»
- å·²ç™»å½•çš„ç”¨æˆ·ä¹Ÿå¯èƒ½éœ€è¦ä¸ºå…¶ä»–å…¬å¸ç”³è¯·å…¥é©»

## âœ… è§£å†³æ–¹æ¡ˆ

ç§»é™¤å…¥é©»ç”³è¯·ç›¸å…³é¡µé¢çš„ `requiresGuest` é™åˆ¶ï¼Œä½¿å…¶å…è®¸ä»»ä½•äººè®¿é—®ã€‚

### ä¿®æ”¹å‰
```typescript
{
  path: '/settlement',
  name: 'SettlementChoice',
  component: SettlementChoice,
  meta: { requiresGuest: true }  // âŒ åªå…è®¸æœªç™»å½•ç”¨æˆ·
},
{
  path: '/settlement/enterprise',
  name: 'EnterpriseSettlement',
  component: EnterpriseSettlement,
  meta: { requiresGuest: true }  // âŒ åªå…è®¸æœªç™»å½•ç”¨æˆ·
},
{
  path: '/settlement/contractor',
  name: 'ContractorSettlement',
  component: ContractorSettlement,
  meta: { requiresGuest: true }  // âŒ åªå…è®¸æœªç™»å½•ç”¨æˆ·
}
```

### ä¿®æ”¹å
```typescript
{
  path: '/settlement',
  name: 'SettlementChoice',
  component: SettlementChoice
  // âœ… å…è®¸ä»»ä½•äººè®¿é—®
},
{
  path: '/settlement/enterprise',
  name: 'EnterpriseSettlement',
  component: EnterpriseSettlement
  // âœ… å…è®¸ä»»ä½•äººè®¿é—®
},
{
  path: '/settlement/contractor',
  name: 'ContractorSettlement',
  component: ContractorSettlement
  // âœ… å…è®¸ä»»ä½•äººè®¿é—®
}
```

## ğŸ“Š è·¯ç”±æƒé™å¯¹æ¯”

| é¡µé¢ | è·¯å¾„ | æƒé™è¦æ±‚ | è¯´æ˜ |
|------|------|---------|------|
| ç™»å½•é¡µé¢ | `/login` | `requiresGuest: true` | åªå…è®¸æœªç™»å½•ç”¨æˆ· |
| ç”¨æˆ·æ³¨å†Œ | `/register` | `requiresGuest: true` | åªå…è®¸æœªç™»å½•ç”¨æˆ· |
| å¿˜è®°å¯†ç  | `/forgot-password` | `requiresGuest: true` | åªå…è®¸æœªç™»å½•ç”¨æˆ· |
| å…¥é©»é€‰æ‹© | `/settlement` | **æ— é™åˆ¶** | âœ… å…è®¸ä»»ä½•äººè®¿é—® |
| ä¼ä¸šå…¥é©» | `/settlement/enterprise` | **æ— é™åˆ¶** | âœ… å…è®¸ä»»ä½•äººè®¿é—® |
| æ‰¿åŒ…å•†å…¥é©» | `/settlement/contractor` | **æ— é™åˆ¶** | âœ… å…è®¸ä»»ä½•äººè®¿é—® |
| ä»ªè¡¨æ¿ | `/dashboard` | `requiresAuth: true` | åªå…è®¸å·²ç™»å½•ç”¨æˆ· |
| å…¶ä»–åŠŸèƒ½é¡µ | `/projects`, `/areas` ç­‰ | `requiresAuth: true` | åªå…è®¸å·²ç™»å½•ç”¨æˆ· |

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1ï¼šæœªç™»å½•ç”¨æˆ·
1. è®¿é—® `/login`
2. ç‚¹å‡»"ç«‹å³ç”³è¯·"
3. è¿›å…¥ `/settlement`
4. ç‚¹å‡»"ä¼ä¸šå…¥é©»"
5. âœ… åº”è¯¥è·³è½¬åˆ° `/settlement/enterprise`

### æµ‹è¯•åœºæ™¯2ï¼šå·²ç™»å½•ç”¨æˆ·
1. ä½¿ç”¨è´¦å·ç™»å½•ç³»ç»Ÿ
2. åœ¨åœ°å€æ è¾“å…¥ `/settlement`
3. âœ… åº”è¯¥æ­£å¸¸æ˜¾ç¤ºå…¥é©»é€‰æ‹©é¡µé¢
4. ç‚¹å‡»"ä¼ä¸šå…¥é©»"
5. âœ… åº”è¯¥è·³è½¬åˆ° `/settlement/enterprise`

### æµ‹è¯•åœºæ™¯3ï¼šä»ç™»å½•é¡µé¢è®¿é—®
1. è®¿é—® `/login`
2. ç‚¹å‡»"ç«‹å³ç”³è¯·"
3. âœ… åº”è¯¥è·³è½¬åˆ° `/settlement`
4. ç‚¹å‡»"æ‰¿åŒ…å•†å…¥é©»"
5. âœ… åº”è¯¥è·³è½¬åˆ° `/settlement/contractor`

## ğŸ’¡ è®¾è®¡è€ƒè™‘

### ä¸ºä»€ä¹ˆå…¥é©»ç”³è¯·å…è®¸ä»»ä½•äººè®¿é—®ï¼Ÿ

1. **ä¸šåŠ¡çµæ´»æ€§**
   - æ–°å…¬å¸éœ€è¦ç”³è¯·å…¥é©»ï¼ˆæœªç™»å½•ï¼‰
   - å·²æœ‰å…¬å¸çš„å‘˜å·¥å¯èƒ½éœ€è¦ä¸ºåˆ†å…¬å¸ç”³è¯·å…¥é©»ï¼ˆå·²ç™»å½•ï¼‰
   - ç³»ç»Ÿç®¡ç†å‘˜å¯èƒ½éœ€è¦ååŠ©ä¼ä¸šç”³è¯·å…¥é©»ï¼ˆå·²ç™»å½•ï¼‰

2. **ç”¨æˆ·ä½“éªŒ**
   - ç”¨æˆ·ä¸éœ€è¦å…ˆç™»å½•æ‰èƒ½æŸ¥çœ‹å…¥é©»ç”³è¯·æµç¨‹
   - é™ä½å…¥é©»é—¨æ§›ï¼Œæé«˜è½¬åŒ–ç‡

3. **å®‰å…¨æ€§**
   - å…¥é©»ç”³è¯·éœ€è¦ç®¡ç†å‘˜å®¡æ ¸ï¼Œä¸ä¼šç›´æ¥åˆ›å»ºå…¬å¸
   - å³ä½¿æ¶æ„ç”¨æˆ·æäº¤å¤šä¸ªç”³è¯·ï¼Œä¹Ÿä¸ä¼šå½±å“ç³»ç»Ÿå®‰å…¨

### ä¸ºä»€ä¹ˆç™»å½•/æ³¨å†Œé¡µé¢é™åˆ¶å·²ç™»å½•ç”¨æˆ·ï¼Ÿ

1. **é€»è¾‘åˆç†æ€§**
   - å·²ç™»å½•ç”¨æˆ·ä¸éœ€è¦å†æ¬¡ç™»å½•
   - å·²ç™»å½•ç”¨æˆ·ä¸éœ€è¦æ³¨å†Œæ–°è´¦å·

2. **é˜²æ­¢æ··æ·†**
   - é¿å…ç”¨æˆ·åœ¨å·²ç™»å½•çŠ¶æ€ä¸‹è¯¯æ“ä½œ
   - æä¾›æ¸…æ™°çš„ç”¨æˆ·ä½“éªŒ

## ğŸ”„ å…¶ä»–å¯èƒ½çš„æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®æ”¹è·¯ç”±å®ˆå«é€»è¾‘ï¼ˆä¸æ¨èï¼‰
```typescript
router.beforeEach(async (to, from, next) => {
  const authStore = useAuthStore()

  if (!authStore.isAuthenticated) {
    await authStore.checkAuth()
  }

  // ç‰¹æ®Šå¤„ç†å…¥é©»ç”³è¯·é¡µé¢
  if (to.path.startsWith('/settlement')) {
    next()  // ç›´æ¥æ”¾è¡Œ
    return
  }

  if (to.meta.requiresAuth && !authStore.isAuthenticated) {
    next('/login')
  } else if (to.meta.requiresGuest && authStore.isAuthenticated) {
    next('/dashboard')
  } else {
    next()
  }
})
```

**ç¼ºç‚¹**ï¼š
- å¢åŠ äº†è·¯ç”±å®ˆå«çš„å¤æ‚åº¦
- ç¡¬ç¼–ç äº†è·¯å¾„åˆ¤æ–­
- ä¸å¤Ÿä¼˜é›…

### æ–¹æ¡ˆ2ï¼šæ·»åŠ æ–°çš„ meta æ ‡è®°ï¼ˆè¿‡åº¦è®¾è®¡ï¼‰
```typescript
{
  path: '/settlement',
  meta: { allowAll: true }  // å…è®¸æ‰€æœ‰äººè®¿é—®
}
```

**ç¼ºç‚¹**ï¼š
- å¢åŠ äº†ä¸å¿…è¦çš„å¤æ‚åº¦
- é»˜è®¤è¡Œä¸ºå°±æ˜¯å…è®¸æ‰€æœ‰äººè®¿é—®

### æ–¹æ¡ˆ3ï¼šå½“å‰æ–¹æ¡ˆï¼ˆæ¨èï¼‰âœ…
ç›´æ¥ç§»é™¤ `requiresGuest` é™åˆ¶ï¼Œä½¿ç”¨é»˜è®¤è¡Œä¸ºã€‚

**ä¼˜ç‚¹**ï¼š
- ç®€å•ç›´æ¥
- ç¬¦åˆç›´è§‰
- æ˜“äºç»´æŠ¤

## ğŸ“ ä¿®æ”¹æ–‡ä»¶

- `/web/src/router/index.ts`

## âœ… ä¿®å¤å®Œæˆ

é—®é¢˜å·²ä¿®å¤ï¼Œç°åœ¨å…¥é©»ç”³è¯·é¡µé¢å¯ä»¥æ­£å¸¸è®¿é—®äº†ï¼

---

**ä¿®å¤æ—¥æœŸ**: 2025-11-10
**é—®é¢˜ç±»å‹**: è·¯ç”±æƒé™é…ç½®é”™è¯¯
**å½±å“èŒƒå›´**: å…¥é©»ç”³è¯·æµç¨‹
**è§£å†³æ–¹æ¡ˆ**: ç§»é™¤ `requiresGuest` é™åˆ¶

