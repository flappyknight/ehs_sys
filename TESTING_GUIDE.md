# 登录注册功能测试指南

## 测试环境准备

### 1. 启动后端服务
```bash
cd /Users/dubin/work/ehs_sys
./start-server.sh
```

### 2. 启动前端服务
```bash
cd /Users/dubin/work/ehs_sys/web
npm run dev
```

### 3. 访问地址
- 前端地址：http://localhost:5173
- 后端地址：http://localhost:8100
- API文档：http://localhost:8100/docs

## 测试用例

### 测试1：登录页面UI检查
**步骤：**
1. 打开浏览器访问 http://localhost:5173/login
2. 检查页面是否正确显示

**预期结果：**
- ✅ 页面标题显示"EHS 系统登录"
- ✅ 显示"身份选择"下拉框，包含三个选项：企业、承包商、系统管理
- ✅ 默认选中"企业"
- ✅ 显示"用户名"输入框
- ✅ 显示"密码"输入框
- ✅ 显示"登录"按钮（蓝色）
- ✅ 显示"还没有账号？"文字和"立即注册"按钮

### 测试2：注册页面导航
**步骤：**
1. 在登录页面点击"立即注册"按钮

**预期结果：**
- ✅ 页面跳转到 http://localhost:5173/register
- ✅ 页面标题显示"EHS 系统注册"

### 测试3：注册页面UI检查
**步骤：**
1. 访问注册页面

**预期结果：**
- ✅ 显示"身份选择"下拉框，包含两个选项：企业、承包商
- ✅ 显示提示文字"系统管理员账号需要联系管理员创建"
- ✅ 显示所有必填字段（带*标记）
- ✅ 显示"注册"按钮（绿色）
- ✅ 显示"已有账号？"文字和"立即登录"按钮

### 测试4：动态表单字段
**步骤：**
1. 在注册页面选择"企业"
2. 观察表单字段
3. 切换到"承包商"
4. 观察表单字段变化

**预期结果：**
- ✅ 选择"企业"时显示：企业名称、职位字段
- ✅ 选择"承包商"时显示：承包商公司名称字段
- ✅ 字段切换流畅，无闪烁

### 测试5：企业用户注册
**步骤：**
1. 访问注册页面
2. 选择身份类型："企业"
3. 填写表单：
   - 用户名：test_enterprise_001
   - 密码：123456
   - 确认密码：123456
   - 姓名：张三
   - 手机号：13800138000
   - 邮箱：zhangsan@example.com
   - 企业名称：测试企业有限公司
   - 职位：安全经理
4. 点击"注册"按钮

**预期结果：**
- ✅ 显示"注册成功！3秒后跳转到登录页面..."
- ✅ 3秒后自动跳转到登录页面
- ✅ 数据库中创建了对应的用户记录

### 测试6：承包商用户注册
**步骤：**
1. 访问注册页面
2. 选择身份类型："承包商"
3. 填写表单：
   - 用户名：test_contractor_001
   - 密码：123456
   - 确认密码：123456
   - 姓名：李四
   - 手机号：13900139000
   - 邮箱：lisi@example.com
   - 承包商公司名称：测试承包商公司
4. 点击"注册"按钮

**预期结果：**
- ✅ 显示"注册成功！3秒后跳转到登录页面..."
- ✅ 3秒后自动跳转到登录页面
- ✅ 数据库中创建了对应的用户记录

### 测试7：表单验证 - 密码不一致
**步骤：**
1. 访问注册页面
2. 填写表单，密码和确认密码输入不同的值
3. 点击"注册"按钮

**预期结果：**
- ✅ 显示错误提示："两次输入的密码不一致"
- ✅ 不提交表单

### 测试8：表单验证 - 密码长度不足
**步骤：**
1. 访问注册页面
2. 填写表单，密码输入少于6位（如：12345）
3. 点击"注册"按钮

**预期结果：**
- ✅ 显示错误提示："密码长度至少为6位"
- ✅ 不提交表单

### 测试9：表单验证 - 手机号格式错误
**步骤：**
1. 访问注册页面
2. 填写表单，手机号输入错误格式（如：12345678901）
3. 点击"注册"按钮

**预期结果：**
- ✅ 显示错误提示："请输入有效的手机号"
- ✅ 不提交表单

### 测试10：表单验证 - 用户名重复
**步骤：**
1. 访问注册页面
2. 使用已存在的用户名（如：admin）
3. 填写其他必填字段
4. 点击"注册"按钮

**预期结果：**
- ✅ 显示错误提示："用户名已存在"
- ✅ 不创建新用户

### 测试11：企业用户登录
**步骤：**
1. 访问登录页面
2. 选择身份类型："企业"
3. 输入用户名：test_enterprise_001
4. 输入密码：123456
5. 点击"登录"按钮

**预期结果：**
- ✅ 登录成功
- ✅ 跳转到仪表板页面
- ✅ 显示用户信息

### 测试12：承包商用户登录
**步骤：**
1. 访问登录页面
2. 选择身份类型："承包商"
3. 输入用户名：test_contractor_001
4. 输入密码：123456
5. 点击"登录"按钮

**预期结果：**
- ✅ 登录成功
- ✅ 跳转到仪表板页面
- ✅ 显示用户信息

### 测试13：系统管理员登录
**步骤：**
1. 访问登录页面
2. 选择身份类型："系统管理"
3. 输入用户名：admin
4. 输入密码：admin123
5. 点击"登录"按钮

**预期结果：**
- ✅ 登录成功
- ✅ 跳转到仪表板页面
- ✅ 显示管理员权限菜单

### 测试14：登录失败 - 用户名或密码错误
**步骤：**
1. 访问登录页面
2. 输入错误的用户名或密码
3. 点击"登录"按钮

**预期结果：**
- ✅ 显示错误提示："Incorrect username or password"
- ✅ 不跳转页面

### 测试15：已登录用户访问登录/注册页面
**步骤：**
1. 先登录系统
2. 在地址栏输入 http://localhost:5173/login 或 /register

**预期结果：**
- ✅ 自动重定向到仪表板页面
- ✅ 不显示登录/注册页面

### 测试16：注册页面返回登录
**步骤：**
1. 访问注册页面
2. 点击"立即登录"按钮

**预期结果：**
- ✅ 页面跳转到登录页面

### 测试17：API接口测试 - 注册
**步骤：**
1. 打开 http://localhost:8100/docs
2. 找到 POST /register 接口
3. 点击"Try it out"
4. 输入测试数据：
```json
{
  "username": "api_test_user",
  "password": "123456",
  "userType": "enterprise",
  "name": "API测试用户",
  "phone": "13700137000",
  "email": "apitest@example.com",
  "companyName": "API测试企业"
}
```
5. 点击"Execute"

**预期结果：**
- ✅ 返回状态码：200
- ✅ 返回数据包含：message: "注册成功", user_id: [数字]

### 测试18：API接口测试 - 登录
**步骤：**
1. 打开 http://localhost:8100/docs
2. 找到 POST /token 接口
3. 点击"Try it out"
4. 输入用户名和密码
5. 点击"Execute"

**预期结果：**
- ✅ 返回状态码：200
- ✅ 返回数据包含：access_token, token_type: "bearer"

## 数据库验证

### 验证企业用户注册
```sql
-- 查看用户表
SELECT * FROM users WHERE username = 'test_enterprise_001';

-- 查看企业表
SELECT * FROM company WHERE name = '测试企业有限公司';

-- 查看企业用户表
SELECT * FROM enterprise_user WHERE name = '张三';
```

**预期结果：**
- ✅ users表中有对应记录，user_type='enterprise'
- ✅ company表中有对应记录，type='enterprise'
- ✅ enterprise_user表中有对应记录，role_type='manager'

### 验证承包商用户注册
```sql
-- 查看用户表
SELECT * FROM users WHERE username = 'test_contractor_001';

-- 查看承包商表
SELECT * FROM contractor WHERE company_name = '测试承包商公司';

-- 查看承包商用户表
SELECT * FROM contractor_user WHERE name = '李四';
```

**预期结果：**
- ✅ users表中有对应记录，user_type='contractor'
- ✅ contractor表中有对应记录
- ✅ contractor_user表中有对应记录，role_type='manager'

## 常见问题排查

### 问题1：页面无法访问
**解决方案：**
1. 检查前端服务是否启动：`npm run dev`
2. 检查端口是否被占用
3. 检查浏览器控制台是否有错误

### 问题2：注册/登录失败
**解决方案：**
1. 检查后端服务是否启动
2. 检查数据库连接是否正常
3. 查看后端日志：`tail -f server.log`
4. 检查浏览器网络请求

### 问题3：数据库错误
**解决方案：**
1. 检查数据库是否启动：`docker ps`
2. 检查数据库连接配置
3. 查看数据库日志

### 问题4：前端显示异常
**解决方案：**
1. 清除浏览器缓存
2. 检查浏览器控制台错误
3. 重新启动前端服务

## 性能测试

### 测试1：并发注册
使用工具（如Apache Bench）测试并发注册：
```bash
# 测试100个并发请求
ab -n 100 -c 10 -p register.json -T application/json http://localhost:8100/register
```

### 测试2：并发登录
```bash
# 测试100个并发请求
ab -n 100 -c 10 -p login.txt -T application/x-www-form-urlencoded http://localhost:8100/token
```

## 测试报告模板

```
测试日期：____________________
测试人员：____________________
测试环境：____________________

| 测试用例 | 测试结果 | 备注 |
|---------|---------|------|
| 测试1   | ✅/❌   |      |
| 测试2   | ✅/❌   |      |
| ...     | ✅/❌   |      |

发现的问题：
1. 
2. 
3. 

改进建议：
1. 
2. 
3. 
```

